<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Trip Planner Pro v0.30</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        /* Transitions */
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar { height: 6px; width: 6px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }

        /* UI Components */
        .bento-card { background: white; border-radius: 1.2rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05); border: 1px solid #f3f4f6; }
        .filter-btn { transition: all 0.2s; white-space: nowrap; }
        .filter-btn.active { color: white; border-color: transparent; transform: scale(1.05); }
        #fil-all.active { background-color: #374151; }
        #fil-activity.active { background-color: #4f46e5; }
        #fil-flight.active { background-color: #2563eb; }
        #fil-transport.active { background-color: #059669; }
        #fil-stay.active { background-color: #ea580c; }

        /* Route Line Logic */
        .route-connector { position: relative; }
        .route-connector::after { content: ''; position: absolute; top: 50%; right: -1rem; width: 1rem; height: 2px; background: #e5e7eb; transform: translateY(-50%); }
        .route-card:last-child .route-connector::after { display: none; }

        /* Mobile Inputs */
        input, select, textarea { font-size: 16px !important; } /* Prevent iOS Zoom */
    </style>
</head>
<body class="bg-gray-50 text-gray-800 antialiased min-h-screen flex flex-col pb-safe">

    <nav class="bg-white border-b border-gray-200 sticky top-0 z-50 shadow-sm safe-top">
        <div class="max-w-7xl mx-auto px-2 md:px-4">
            <div class="flex justify-between h-14 md:h-16">
                <div class="flex items-center gap-2 md:gap-3 flex-shrink-0">
                    <div class="bg-indigo-600 p-1.5 rounded-lg text-white shadow-md">
                        <i data-lucide="map" class="w-5 h-5"></i>
                    </div>
                    <div class="flex flex-col cursor-pointer" onclick="openTripManager()">
                        <span class="font-black text-xs text-indigo-500 tracking-wider uppercase hidden md:block">v0.30 Pro</span>
                        <div class="flex items-center gap-1 hover:bg-gray-50 rounded pr-2 transition-colors">
                            <span id="current-trip-name" class="text-sm md:text-base font-bold text-gray-900 truncate max-w-[120px] md:max-w-[200px]">Select Trip</span>
                            <i data-lucide="chevron-down" class="w-3 h-3 text-gray-400"></i>
                        </div>
                    </div>
                </div>
                
                <div class="flex items-center gap-1 md:gap-2 flex-grow justify-end md:justify-center">
                    <button onclick="switchTab('summary')" id="btn-summary" class="tab-btn p-2 md:px-3 md:py-2 rounded-lg text-sm font-bold bg-indigo-50 text-indigo-700 flex flex-col md:flex-row items-center gap-0.5 md:gap-2">
                        <i data-lucide="layout-grid" class="w-5 h-5 md:w-4 md:h-4"></i>
                        <span class="text-[10px] md:text-sm font-medium">Dash</span>
                    </button>
                    <button onclick="switchTab('journey')" id="btn-journey" class="tab-btn p-2 md:px-3 md:py-2 rounded-lg text-sm font-medium text-gray-500 hover:bg-gray-50 flex flex-col md:flex-row items-center gap-0.5 md:gap-2">
                        <i data-lucide="book-open" class="w-5 h-5 md:w-4 md:h-4"></i>
                        <span class="text-[10px] md:text-sm font-medium">Plan</span>
                    </button>
                    <button onclick="switchTab('budget')" id="btn-budget" class="tab-btn p-2 md:px-3 md:py-2 rounded-lg text-sm font-medium text-gray-500 hover:bg-gray-50 flex flex-col md:flex-row items-center gap-0.5 md:gap-2">
                        <i data-lucide="pie-chart" class="w-5 h-5 md:w-4 md:h-4"></i>
                        <span class="text-[10px] md:text-sm font-medium">Money</span>
                    </button>
                </div>

                <div class="flex items-center border-l border-gray-200 ml-1 pl-1 md:ml-2 md:pl-2 relative">
                    <button id="btn-data-menu" onclick="toggleDataMenu()" class="p-2 text-gray-500 hover:text-indigo-600 rounded-lg active:bg-gray-100">
                        <i data-lucide="more-vertical" class="w-5 h-5"></i>
                    </button>
                    <div id="data-dropdown" class="absolute right-0 top-12 w-56 bg-white rounded-xl shadow-xl border border-gray-100 hidden z-50 overflow-hidden ring-1 ring-black ring-opacity-5 animate-fade-in-down">
                        <div class="px-4 py-2 bg-gray-50 border-b border-gray-100">
                            <span class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Project Actions</span>
                        </div>
                        <button onclick="renameTrip()" class="w-full text-left px-4 py-3 text-sm hover:bg-gray-50 flex items-center gap-3 text-gray-700">
                            <i data-lucide="edit-2" class="w-4 h-4 text-gray-400"></i> Rename Project
                        </button>
                        <button onclick="saveCopy()" class="w-full text-left px-4 py-3 text-sm hover:bg-gray-50 flex items-center gap-3 text-gray-700">
                            <i data-lucide="copy" class="w-4 h-4 text-gray-400"></i> Save as Copy
                        </button>
                        <div class="border-t border-gray-100 my-1"></div>
                        <button onclick="saveToFile()" class="w-full text-left px-4 py-3 text-sm hover:bg-gray-50 flex items-center gap-3 text-gray-700">
                            <i data-lucide="download" class="w-4 h-4 text-gray-400"></i> Export JSON
                        </button>
                        <button onclick="downloadCSV()" class="w-full text-left px-4 py-3 text-sm hover:bg-gray-50 flex items-center gap-3 text-green-700">
                            <i data-lucide="sheet" class="w-4 h-4 text-green-500"></i> Export CSV (Spend)
                        </button>
                        <div class="border-t border-gray-100 my-1"></div>
                        <button onclick="resetData()" class="w-full text-left px-4 py-3 text-sm hover:bg-red-50 flex items-center gap-3 text-red-600">
                            <i data-lucide="trash-2" class="w-4 h-4"></i> Reset Data
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <main id="tab-summary" class="tab-content active w-full flex-grow p-4 md:p-8">
        <div class="max-w-6xl mx-auto space-y-4 md:space-y-6">
            <header class="flex justify-between items-end mb-2">
                <div>
                    <h1 class="text-2xl md:text-3xl font-black text-gray-900">Overview</h1>
                    <p class="text-sm text-gray-500">Trip Status Dashboard</p>
                </div>
                <div id="sum-dday" class="text-xl md:text-3xl font-black text-indigo-600 bg-indigo-50 px-3 py-1 rounded-lg">-</div>
            </header>

            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="bento-card md:col-span-2 p-6 bg-gradient-to-br from-gray-900 to-gray-800 text-white flex flex-col justify-between relative overflow-hidden min-h-[200px]">
                    <div class="absolute right-[-20px] bottom-[-20px] opacity-10"><i data-lucide="globe-2" class="w-48 h-48"></i></div>
                    <div>
                        <div class="flex items-center gap-2 mb-2">
                            <span class="bg-white/20 px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider backdrop-blur-sm">PRO Plan</span>
                        </div>
                        <h2 class="text-2xl md:text-3xl font-black leading-tight truncate pr-4" id="sum-title">No Trip Selected</h2>
                    </div>
                    <div class="mt-6 z-10">
                        <div class="text-gray-300 font-medium text-sm flex items-center gap-2">
                            <i data-lucide="calendar" class="w-4 h-4"></i>
                            <span id="sum-dates">Set schedule</span>
                        </div>
                    </div>
                </div>

                <div class="bento-card md:col-span-1 p-5 flex flex-row md:flex-col items-center justify-between md:justify-center gap-4">
                    <div class="text-left md:text-center">
                        <div class="text-xs font-bold text-gray-400 uppercase mb-1">Budget Left</div>
                        <div class="font-black text-2xl text-gray-800" id="sum-remain-pct">0%</div>
                        <div class="text-xs text-gray-500 mt-1">Spent: <span id="sum-spent-total" class="font-bold text-indigo-600">0</span></div>
                    </div>
                    <div class="relative w-20 h-20 md:w-28 md:h-28 flex-shrink-0">
                        <canvas id="sumChartBudget"></canvas>
                    </div>
                </div>

                <div class="bento-card md:col-span-1 p-5 grid grid-cols-3 md:grid-cols-1 gap-2 md:gap-4 content-center">
                    <div class="bg-blue-50 p-3 rounded-xl flex flex-col items-center justify-center">
                        <i data-lucide="plane" class="w-5 h-5 text-blue-600 mb-1"></i>
                        <span class="text-lg font-black text-gray-800" id="cnt-flight">0</span>
                        <span class="text-[10px] text-gray-400 font-bold uppercase">Flights</span>
                    </div>
                    <div class="bg-orange-50 p-3 rounded-xl flex flex-col items-center justify-center">
                        <i data-lucide="home" class="w-5 h-5 text-orange-600 mb-1"></i>
                        <span class="text-lg font-black text-gray-800" id="cnt-stay">0</span>
                        <span class="text-[10px] text-gray-400 font-bold uppercase">Stays</span>
                    </div>
                    <div class="bg-emerald-50 p-3 rounded-xl flex flex-col items-center justify-center">
                        <i data-lucide="map" class="w-5 h-5 text-emerald-600 mb-1"></i>
                        <span class="text-lg font-black text-gray-800" id="cnt-activity">0</span>
                        <span class="text-[10px] text-gray-400 font-bold uppercase">Acts</span>
                    </div>
                </div>

                <div class="bento-card md:col-span-4 p-5 md:p-6 bg-white">
                    <div class="flex justify-between items-center mb-4">
                        <div class="text-xs font-bold text-gray-400 uppercase flex items-center gap-2">
                            <i data-lucide="git-branch" class="w-4 h-4"></i> Travel Route
                        </div>
                    </div>
                    <div class="flex items-center gap-4 overflow-x-auto pb-4 pt-2 custom-scroll touch-pan-x" id="sum-route-flow">
                        <span class="text-gray-400 italic text-sm w-full text-center py-6">
                            Add flights or transport in the Plan tab to visualize your route.
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <main id="tab-journey" class="tab-content w-full flex-grow p-4 md:p-8 bg-gray-50/50">
        <div class="max-w-2xl mx-auto">
            <div class="sticky top-16 md:top-20 z-40 bg-white/90 backdrop-blur-md p-2 rounded-2xl border border-gray-200 shadow-sm w-full md:w-fit mx-auto mb-8 overflow-x-auto flex gap-2 custom-scroll">
                <button onclick="toggleFilter('all')" id="fil-all" class="filter-btn active px-4 py-2 rounded-xl text-xs font-bold border border-gray-200 bg-gray-50 text-gray-500">All</button>
                <button onclick="toggleFilter('activity')" id="fil-activity" class="filter-btn px-4 py-2 rounded-xl text-xs font-bold border border-gray-200 bg-white text-gray-500 hover:text-indigo-600">Activity</button>
                <button onclick="toggleFilter('flight')" id="fil-flight" class="filter-btn px-4 py-2 rounded-xl text-xs font-bold border border-gray-200 bg-white text-gray-500 hover:text-blue-600">Flight</button>
                <button onclick="toggleFilter('transport')" id="fil-transport" class="filter-btn px-4 py-2 rounded-xl text-xs font-bold border border-gray-200 bg-white text-gray-500 hover:text-emerald-600">Transit</button>
                <button onclick="toggleFilter('stay')" id="fil-stay" class="filter-btn px-4 py-2 rounded-xl text-xs font-bold border border-gray-200 bg-white text-gray-500 hover:text-orange-600">Stay</button>
            </div>

            <div class="bg-white p-4 md:p-6 rounded-2xl shadow-sm border border-gray-200 mb-8 ring-1 ring-black/5">
                <div class="flex flex-col gap-4">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-3">
                        <h3 class="font-bold text-gray-800 flex items-center gap-2">
                            <span class="bg-indigo-100 text-indigo-600 p-1 rounded"><i data-lucide="plus" class="w-4 h-4"></i></span>
                            <span id="edit-form-title">Add Schedule</span>
                        </h3>
                        <div class="flex bg-gray-100 rounded-lg p-1 w-full md:w-auto overflow-x-auto custom-scroll">
                            <button onclick="setType('activity')" id="type-activity" class="flex-1 md:flex-none px-4 py-2 text-xs font-bold rounded-md bg-white shadow-sm text-indigo-600 transition-all">Activity</button>
                            <button onclick="setType('flight')" id="type-flight" class="flex-1 md:flex-none px-4 py-2 text-xs font-bold rounded-md text-gray-500 transition-all">Flight</button>
                            <button onclick="setType('transport')" id="type-transport" class="flex-1 md:flex-none px-4 py-2 text-xs font-bold rounded-md text-gray-500 transition-all">Transit</button>
                            <button onclick="setType('stay')" id="type-stay" class="flex-1 md:flex-none px-4 py-2 text-xs font-bold rounded-md text-gray-500 transition-all">Stay</button>
                        </div>
                    </div>

                    <div class="space-y-3">
                        <div class="flex gap-2">
                            <select id="in-icon" class="w-16 p-3 border border-gray-200 rounded-xl text-xl bg-gray-50 text-center outline-none focus:ring-2 focus:ring-indigo-500">
                                <option value="üìç">üìç</option><option value="üì∑">üì∑</option><option value="üçî">üçî</option><option value="‚òï">‚òï</option><option value="üõçÔ∏è">üõçÔ∏è</option><option value="‚úàÔ∏è">‚úàÔ∏è</option><option value="üöÜ">üöÜ</option><option value="üöå">üöå</option><option value="üöó">üöó</option><option value="üè®">üè®</option><option value="üè†">üè†</option>
                            </select>
                            <input id="in-name" type="text" placeholder="Place Name / Title" class="flex-grow p-3 border border-gray-200 rounded-xl bg-gray-50 outline-none focus:ring-2 focus:ring-indigo-500 font-medium">
                            <div id="route-inputs" class="flex-grow flex gap-2 hidden">
                                <input id="in-from" type="text" placeholder="From" class="w-1/2 p-3 border border-gray-200 rounded-xl bg-gray-50 outline-none focus:ring-2 focus:ring-indigo-500 font-medium">
                                <div class="flex items-center text-gray-400">‚ûú</div>
                                <input id="in-to" type="text" placeholder="To" class="w-1/2 p-3 border border-gray-200 rounded-xl bg-gray-50 outline-none focus:ring-2 focus:ring-indigo-500 font-medium">
                            </div>
                        </div>

                        <div class="bg-gray-50 p-3 rounded-xl border border-gray-200">
                            <div class="grid grid-cols-2 gap-3 mb-3">
                                <div><label class="block text-[10px] font-bold text-gray-400 mb-1 uppercase">Start</label><input id="in-start-date" type="date" class="w-full p-2 border border-gray-200 rounded-lg text-sm bg-white"></div>
                                <div><label class="block text-[10px] font-bold text-gray-400 mb-1 uppercase">Time</label><input id="in-start-time" type="time" class="w-full p-2 border border-gray-200 rounded-lg text-sm bg-white"></div>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div><label class="block text-[10px] font-bold text-gray-400 mb-1 uppercase">End</label><input id="in-end-date" type="date" class="w-full p-2 border border-gray-200 rounded-lg text-sm bg-white"></div>
                                <div><label class="block text-[10px] font-bold text-gray-400 mb-1 uppercase">Time</label><input id="in-end-time" type="time" class="w-full p-2 border border-gray-200 rounded-lg text-sm bg-white"></div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 gap-3">
                            <input id="in-link" type="text" placeholder="Google Map Link (URL)" class="w-full p-3 border border-gray-200 rounded-xl bg-gray-50 outline-none focus:ring-2 focus:ring-indigo-500 text-sm text-blue-600">
                            <input id="in-note" type="text" placeholder="Notes / Memos" class="w-full p-3 border border-gray-200 rounded-xl bg-gray-50 outline-none focus:ring-2 focus:ring-indigo-500 text-sm">
                        </div>

                        <div class="flex gap-2 pt-2">
                            <button onclick="addItem()" id="btn-add-item" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white py-3.5 rounded-xl font-bold shadow-lg shadow-indigo-200 transition-all flex justify-center items-center gap-2">
                                <i data-lucide="check" class="w-4 h-4"></i> Add to Plan
                            </button>
                            <button onclick="cancelEdit()" id="btn-cancel-edit" class="w-1/3 bg-gray-200 hover:bg-gray-300 text-gray-600 py-3.5 rounded-xl font-bold hidden">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="timeline-feed" class="space-y-10 pb-24 px-1"></div>
            <div id="journey-empty" class="text-center py-20 hidden">
                <div class="text-gray-300 mb-2"><i data-lucide="calendar-x" class="w-12 h-12 mx-auto"></i></div>
                <p class="text-gray-400 font-medium">No schedules yet.</p>
                <p class="text-xs text-gray-400">Use the form above to create your trip.</p>
            </div>
        </div>
    </main>

    <main id="tab-budget" class="tab-content w-full flex-grow p-4 md:p-8 bg-gray-50">
        <div class="max-w-4xl mx-auto space-y-6">
            
            <div class="bg-white p-5 md:p-6 rounded-2xl shadow-sm border border-gray-200">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-bold text-gray-800 text-lg flex items-center gap-2">
                        <i data-lucide="wallet" class="w-5 h-5 text-indigo-600"></i> Budget Pro
                    </h3>
                    <div class="text-right">
                        <div class="text-[10px] font-bold text-gray-400 uppercase">Total Budget</div>
                        <div class="flex items-center gap-1 justify-end">
                            <span class="text-gray-400 text-sm">‚Ç©</span>
                            <input type="number" id="smart-total" class="bg-transparent text-xl md:text-2xl font-black text-indigo-900 outline-none w-32 md:w-40 border-b border-indigo-200 focus:border-indigo-600 text-right" value="0" onchange="updateAllFromTotal()">
                        </div>
                    </div>
                </div>

                <div class="overflow-x-auto custom-scroll pb-2">
                    <table class="w-full text-sm min-w-[350px]">
                        <thead>
                            <tr class="text-xs text-gray-400 border-b border-gray-100">
                                <th class="text-left py-2 font-bold uppercase">Category</th>
                                <th class="text-right py-2 font-bold uppercase w-20">%</th>
                                <th class="text-right py-2 font-bold uppercase w-28">Limit</th>
                                <th class="text-right py-2 font-bold uppercase w-24">Spent</th>
                            </tr>
                        </thead>
                        <tbody id="smart-budget-rows" class="divide-y divide-gray-50"></tbody>
                    </table>
                </div>
            </div>

            <section class="bg-white p-5 rounded-2xl shadow-sm border border-gray-200">
                <h4 class="font-bold text-gray-800 mb-4 text-sm flex items-center gap-2">
                    <i data-lucide="credit-card" class="w-4 h-4 text-gray-500"></i> Add Transaction
                </h4>
                <div class="grid grid-cols-2 md:grid-cols-12 gap-3">
                    <div class="col-span-1 md:col-span-2"><label class="label-tiny">Date</label><input id="exp-date" type="date" class="input-std"></div>
                    <div class="col-span-1 md:col-span-2"><label class="label-tiny">Category</label><select id="exp-cat" class="input-std bg-gray-50"></select></div>
                    <div class="col-span-2 md:col-span-4"><label class="label-tiny">Item Name</label><input id="exp-item" type="text" placeholder="e.g. Starbucks" class="input-std"></div>
                    <div class="col-span-1 md:col-span-2"><label class="label-tiny text-indigo-600">KRW (‚Ç©)</label><input id="exp-cost" type="number" placeholder="0" class="input-std font-bold text-right text-indigo-700 bg-indigo-50 border-indigo-200"></div>
                    <div class="col-span-1 md:col-span-2"><label class="label-tiny">USD ($)</label><input id="exp-usd" type="number" placeholder="0" class="input-std text-right"></div>
                    
                    <div class="col-span-1 md:col-span-3"><label class="label-tiny">Payer</label><input id="exp-payer" type="text" placeholder="e.g. Me" class="input-std"></div>
                    <div class="col-span-1 md:col-span-3"><label class="label-tiny">Method</label><select id="exp-method" class="input-std bg-white"><option>Credit Card</option><option>Cash</option><option>Travel Wallet</option><option>Other</option></select></div>
                    <div class="col-span-2 md:col-span-4"><label class="label-tiny">Note</label><input id="exp-note" type="text" placeholder="..." class="input-std"></div>
                    <div class="col-span-2 md:col-span-2 flex items-end"><button onclick="addExpense()" class="w-full bg-gray-800 text-white py-2.5 rounded-lg font-bold hover:bg-black transition-all shadow-md">Add</button></div>
                </div>
            </section>

            <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden mb-20">
                <div class="bg-gray-50 px-5 py-3 border-b border-gray-200 flex justify-between items-center">
                    <span class="font-bold text-gray-700 text-sm">Expense Log</span>
                    <div class="text-xs text-gray-400">Scroll to see more ‚ûî</div>
                </div>
                <div class="overflow-x-auto custom-scroll">
                    <table class="w-full text-sm min-w-[800px]">
                        <thead class="bg-gray-50 text-gray-500 font-bold text-[10px] uppercase border-b border-gray-200">
                            <tr>
                                <th class="py-3 px-4 text-left w-24">Date</th>
                                <th class="py-3 px-4 text-left w-24">Cat</th>
                                <th class="py-3 px-4 text-left">Item</th>
                                <th class="py-3 px-4 text-right">KRW</th>
                                <th class="py-3 px-4 text-right">USD</th>
                                <th class="py-3 px-4 text-left w-20">Payer</th>
                                <th class="py-3 px-4 text-left w-24">Method</th>
                                <th class="py-3 px-4 text-left w-32">Note</th>
                                <th class="py-3 px-2 text-center w-10"></th>
                            </tr>
                        </thead>
                        <tbody id="expense-list" class="divide-y divide-gray-50"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <div id="trip-modal" class="hidden fixed inset-0 z-[100] bg-black/60 items-center justify-center backdrop-blur-sm flex p-4">
        <div class="bg-white w-full max-w-md rounded-2xl p-6 shadow-2xl flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2"><i data-lucide="folder-open" class="text-indigo-600"></i> Trip Manager</h2>
                <button onclick="closeTripManager()" class="p-2 text-gray-400 hover:text-gray-800 bg-gray-100 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            
            <div class="flex-grow overflow-y-auto custom-scroll mb-4">
                <div class="text-xs font-bold text-gray-400 uppercase mb-2 sticky top-0 bg-white pb-2">Cloud Saves (Firebase)</div>
                <div id="trip-list" class="space-y-2">
                    <div class="text-center text-gray-400 py-8 text-sm bg-gray-50 rounded-lg border border-dashed border-gray-200">Connecting...</div>
                </div>
            </div>
            
            <div class="border-t pt-4 space-y-4 flex-shrink-0">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Create New Trip</label>
                    <div class="flex gap-2">
                        <input type="text" id="new-trip-name" placeholder="Ex: Tokyo 2025" class="flex-grow p-3 border rounded-lg text-sm bg-gray-50 focus:bg-white outline-none focus:ring-2 focus:ring-indigo-500">
                        <button onclick="createNewTrip()" class="bg-indigo-600 text-white px-5 py-2 rounded-lg font-bold text-sm shadow hover:bg-indigo-700">Create</button>
                    </div>
                </div>
                <div>
                    <label class="w-full flex items-center justify-center gap-2 p-3 border border-dashed border-gray-300 rounded-xl text-sm text-gray-500 hover:bg-indigo-50 hover:text-indigo-600 hover:border-indigo-300 cursor-pointer transition-all">
                        <i data-lucide="upload" class="w-4 h-4"></i> Import JSON File
                        <input type="file" id="modal-file-loader" class="hidden" onchange="loadFromFile(this)">
                    </label>
                </div>
            </div>
        </div>
    </div>

    <style>
        .label-tiny { display: block; font-size: 10px; font-weight: 700; color: #9ca3af; margin-bottom: 4px; text-transform: uppercase; }
        .input-std { width: 100%; padding: 8px 10px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px; outline: none; transition: border-color 0.2s; }
        .input-std:focus { border-color: #6366f1; }
        .safe-top { padding-top: env(safe-area-inset-top); }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
    </style>

    <script>
        // --- CONFIG & GLOBALS ---
        // Placeholder Config - Replace with actual keys for Production
        const firebaseConfig = {
            apiKey: "AIzaSyD9d204Dz2ALB8nRZdSw8gn4R7uCAndKK8",
            authDomain: "mytrip-ef669.firebaseapp.com",
            projectId: "mytrip-ef669",
            storageBucket: "mytrip-ef669.firebasestorage.app",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef"
        };

        let db = null;
        let currentTripId = null;
        let unsubscribe = null;
        let data = { tripName: "My New Trip", totalBudget: 2000000, limits: {}, items: [], expenses: [] };
        
        let editingId = null;
        let activeFilter = 'all';
        let currentType = 'activity';
        let chartBudget = null;
        const CATEGORIES = ['Food', 'Transport', 'Stay', 'Flight', 'Shopping', 'Activity', 'Other'];

        // --- INITIALIZATION ---
        window.onload = function() {
            try {
                if(firebase.apps.length === 0) firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                console.log("System Ready: Firebase Init");
                loadTripList();
            } catch (e) {
                console.warn("Offline Mode / Config Error:", e);
                document.getElementById('trip-list').innerHTML = `<div class="text-center text-red-400 py-4 text-xs">Offline Mode<br>(Firebase Config Required)</div>`;
            }

            // Set Defaults
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('in-start-date').value = today;
            document.getElementById('exp-date').value = today;
            
            const catSel = document.getElementById('exp-cat');
            catSel.innerHTML = '';
            CATEGORIES.forEach(c => catSel.innerHTML += `<option value="${c}">${c}</option>`);

            lucide.createIcons();
            updateUI();
            
            // Auto open manager if not loaded
            if(data.items.length === 0) openTripManager();
        };

        // --- CORE LOGIC ---
        function switchTab(t) {
            document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
            document.getElementById('tab-'+t).classList.add('active');
            
            // Reset button styles
            document.querySelectorAll('.tab-btn').forEach(b => { 
                b.className = "tab-btn p-2 md:px-3 md:py-2 rounded-lg text-sm font-medium text-gray-500 hover:bg-gray-50 flex flex-col md:flex-row items-center gap-0.5 md:gap-2";
            });
            
            // Active button style
            const btn = document.getElementById('btn-'+t);
            btn.className = "tab-btn p-2 md:px-3 md:py-2 rounded-lg text-sm font-bold bg-indigo-50 text-indigo-700 flex flex-col md:flex-row items-center gap-0.5 md:gap-2";
            
            if(t==='summary') renderSummary();
            window.scrollTo(0,0);
        }

        function toggleDataMenu() {
            const menu = document.getElementById('data-dropdown');
            menu.classList.toggle('hidden');
        }
        
        // Close menus when clicking outside
        window.onclick = function(event) {
            if (!event.target.closest('#btn-data-menu') && !event.target.closest('#data-dropdown')) {
                document.getElementById('data-dropdown').classList.add('hidden');
            }
        }

        // --- FIREBASE / DATA MGR ---
        function openTripManager() {
            document.getElementById('trip-modal').classList.remove('hidden');
            document.getElementById('trip-modal').classList.add('flex');
            loadTripList();
        }
        function closeTripManager() {
            document.getElementById('trip-modal').classList.add('hidden');
            document.getElementById('trip-modal').classList.remove('flex');
        }

        function loadTripList() {
            if(!db) return;
            const listEl = document.getElementById('trip-list');
            
            db.collection("trips").get().then((querySnapshot) => {
                listEl.innerHTML = '';
                if (querySnapshot.empty) {
                    listEl.innerHTML = '<div class="text-center text-gray-400 py-4 text-sm">No saved trips found.</div>';
                    return;
                }
                querySnapshot.forEach((doc) => {
                    const t = doc.data();
                    const id = doc.id;
                    const isActive = id === currentTripId;
                    const div = document.createElement('div');
                    div.className = `p-3 rounded-xl border flex justify-between items-center transition-all ${isActive ? 'border-indigo-500 bg-indigo-50 ring-1 ring-indigo-500' : 'border-gray-200 hover:bg-gray-50'}`;
                    div.innerHTML = `
                        <div class="flex flex-col cursor-pointer flex-grow" onclick="loadTrip('${id}', '${t.tripName}')">
                            <span class="font-bold text-gray-800 text-sm">${t.tripName || 'Untitled'}</span>
                            <span class="text-[10px] text-gray-400">ID: ${id.substring(5,10)}...</span>
                        </div>
                        <button onclick="loadTrip('${id}', '${t.tripName}')" class="bg-white border border-gray-200 text-indigo-600 px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-indigo-600 hover:text-white transition-colors shadow-sm">LOAD</button>
                    `;
                    listEl.appendChild(div);
                });
            }).catch((error) => {
                console.error(error);
                listEl.innerHTML = '<div class="text-center text-red-400 text-sm">Error connecting to cloud.</div>';
            });
        }

        function createNewTrip() {
            if(!db) return alert("Database not connected");
            const name = document.getElementById('new-trip-name').value;
            if(!name) return alert("Please enter a trip name");
            
            const newId = 'trip_' + Date.now();
            const newData = { tripName: name, totalBudget: 2000000, limits: {}, items: [], expenses: [] };
            
            db.collection("trips").doc(newId).set(newData).then(() => {
                document.getElementById('new-trip-name').value = '';
                loadTrip(newId, name);
            });
        }

        function loadTrip(id, name) {
            currentTripId = id;
            if (unsubscribe) unsubscribe();
            
            unsubscribe = db.collection("trips").doc(id).onSnapshot((doc) => {
                if (doc.exists) {
                    const cloudData = doc.data();
                    data = { ...data, ...cloudData }; // Merge to keep structure
                    // Ensure defaults
                    if(!data.limits) data.limits = {};
                    CATEGORIES.forEach(c => { if(data.limits[c]===undefined) data.limits[c]=0; });
                    
                    document.getElementById('current-trip-name').innerText = data.tripName;
                    updateUI();
                }
            });
            closeTripManager();
        }

        function save() {
            if(db && currentTripId) {
                db.collection("trips").doc(currentTripId).set(data).catch(e => console.error(e));
            }
            // Local fallback or visual feedback could go here
            renderSummary();
            renderSmartBudget();
        }

        function renameTrip() {
            const newName = prompt("Rename Project:", data.tripName);
            if(newName && newName.trim() !== "") {
                data.tripName = newName;
                document.getElementById('current-trip-name').innerText = newName;
                save();
            }
        }

        function saveCopy() {
            if(!db || !currentTripId) return alert("No active trip to copy");
            const newName = prompt("Name for the copy:", data.tripName + " (Copy)");
            if(!newName) return;
            const newId = 'trip_' + Date.now();
            const copyData = { ...data, tripName: newName };
            db.collection("trips").doc(newId).set(copyData).then(() => {
                alert("Trip copied! Please load it from the manager.");
                openTripManager();
            });
        }

        // --- FILE OPS ---
        function saveToFile() {
            const fileName = (data.tripName || "trip").replace(/[^a-z0-9]/gi, '_').toLowerCase();
            const blob = new Blob([JSON.stringify(data, null, 2)], {type : 'application/json'});
            const link = document.createElement('a'); link.href = URL.createObjectURL(blob); 
            link.download = `${fileName}_v030.json`; 
            link.click();
        }

        function loadFromFile(input) {
            const file = input.files[0]; if(!file) return;
            const reader = new FileReader(); 
            reader.onload = function(e) {
                try {
                    const json = JSON.parse(e.target.result);
                    if(confirm(`Import "${json.tripName}"? This will overwrite current view.`)) {
                        data = json;
                        data.tripName += " (Imported)";
                        currentTripId = null; // Detach from cloud until saved as new
                        document.getElementById('current-trip-name').innerText = data.tripName;
                        updateUI();
                        closeTripManager();
                        alert("Data loaded locally. Create a New Trip in Manager to save to cloud.");
                    }
                } catch(e) { alert("Invalid JSON file"); }
            };
            reader.readAsText(file);
        }

        function resetData() {
            if(confirm("DANGER: This will wipe all Schedules and Expenses for this trip. Continue?")) {
                data.items = [];
                data.expenses = [];
                save();
                updateUI();
                alert("Data reset complete.");
            }
        }

        // --- EXPORT CSV (NEW) ---
        function downloadCSV() {
            // Add BOM for Excel UTF-8 compatibility
            let csvContent = "\uFEFF"; 
            // Header
            csvContent += "Category,Date,Item Name,Cost(KRW),Cost(USD),Payer,Method,Note\n";
            
            data.expenses.forEach(e => {
                // Escape quotes and handle commas
                const clean = (text) => text ? `"${text.toString().replace(/"/g, '""')}"` : "";
                const row = [
                    clean(e.cat),
                    clean(e.date),
                    clean(e.name),
                    e.cost,
                    e.usd || 0,
                    clean(e.payer),
                    clean(e.method),
                    clean(e.note)
                ];
                csvContent += row.join(",") + "\n";
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `Spend_${data.tripName.replace(/\s+/g, '_')}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }


        // --- JOURNEY LOGIC ---
        function updateUI() {
            renderJourney();
            renderSmartBudget();
            renderSummary();
        }

        function toggleFilter(f) {
            activeFilter = f;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('fil-'+f).classList.add('active');
            renderJourney();
        }

        function setType(t){
            currentType = t;
            // Reset styles
            ['activity','flight','transport','stay'].forEach(x => {
                const b = document.getElementById('type-'+x);
                b.className = "flex-1 md:flex-none px-4 py-2 text-xs font-bold rounded-md text-gray-500 transition-all hover:bg-gray-50";
            });
            
            // Set active style
            const activeBtn = document.getElementById('type-'+t);
            activeBtn.className = "flex-1 md:flex-none px-4 py-2 text-xs font-bold rounded-md bg-white shadow-md transition-all ring-1 ring-black/5";
            if(t==='flight') activeBtn.classList.add('text-blue-600');
            else if(t==='transport') activeBtn.classList.add('text-emerald-600');
            else if(t==='stay') activeBtn.classList.add('text-orange-600');
            else activeBtn.classList.add('text-indigo-600');

            // Toggle Inputs
            const i=document.getElementById('in-icon'), n=document.getElementById('in-name'), r=document.getElementById('route-inputs');
            if(t==='flight'||t==='transport'){
                i.value = t==='flight'?'‚úàÔ∏è':'üöÜ';
                n.classList.add('hidden');
                r.classList.remove('hidden'); r.classList.add('flex');
            } else {
                i.value = t==='stay'?'üè®':'üìç';
                n.classList.remove('hidden');
                r.classList.remove('flex'); r.classList.add('hidden');
            }
            clearInputs(false); // false = keep type
        }

        function clearInputs(resetType = true) {
            document.getElementById('in-name').value = '';
            document.getElementById('in-from').value = '';
            document.getElementById('in-to').value = '';
            document.getElementById('in-link').value = '';
            document.getElementById('in-note').value = '';
            document.getElementById('in-start-time').value = '';
            document.getElementById('in-end-time').value = '';
            editingId = null;
            
            document.getElementById('btn-add-item').innerHTML = `<i data-lucide="check" class="w-4 h-4"></i> Add to Plan`;
            document.getElementById('btn-add-item').className = "flex-1 bg-indigo-600 hover:bg-indigo-700 text-white py-3.5 rounded-xl font-bold shadow-lg shadow-indigo-200 transition-all flex justify-center items-center gap-2";
            document.getElementById('btn-cancel-edit').classList.add('hidden');
            document.getElementById('edit-form-title').innerText = "Add Schedule";
            
            if(resetType) lucide.createIcons();
        }

        function cancelEdit() { clearInputs(); }

        function addItem() {
            const d = document.getElementById('in-start-date').value;
            let n = document.getElementById('in-name').value;
            const f = document.getElementById('in-from').value;
            const to = document.getElementById('in-to').value;
            
            if((currentType==='flight'||currentType==='transport') && (!f||!to)) return alert('Please enter From/To locations');
            if(currentType!=='flight' && currentType!=='transport' && !n) return alert('Please enter a Name');
            if(!d) return alert('Please pick a Date');

            const item = {
                id: editingId ? editingId : Date.now(),
                type: currentType,
                icon: document.getElementById('in-icon').value,
                name: n || `${f} ‚ûú ${to}`,
                from: f, to: to,
                link: document.getElementById('in-link').value,
                startDate: d,
                startTime: document.getElementById('in-start-time').value,
                endDate: document.getElementById('in-end-date').value || d,
                endTime: document.getElementById('in-end-time').value,
                note: document.getElementById('in-note').value
            };

            if(editingId) {
                const idx = data.items.findIndex(i => i.id === editingId);
                if(idx !== -1) data.items[idx] = item;
            } else {
                data.items.push(item);
            }
            
            save();
            clearInputs();
            renderJourney();
        }

        function editItem(id) {
            const item = data.items.find(i => i.id === id); if(!item) return;
            window.scrollTo({top:0, behavior:'smooth'});
            setType(item.type);
            
            document.getElementById('in-icon').value = item.icon;
            document.getElementById('in-name').value = item.name;
            document.getElementById('in-from').value = item.from || '';
            document.getElementById('in-to').value = item.to || '';
            document.getElementById('in-link').value = item.link || '';
            document.getElementById('in-note').value = item.note || '';
            document.getElementById('in-start-date').value = item.startDate;
            document.getElementById('in-start-time').value = item.startTime || '';
            document.getElementById('in-end-date').value = item.endDate || item.startDate;
            document.getElementById('in-end-time').value = item.endTime || '';

            editingId = id;
            document.getElementById('btn-add-item').innerHTML = `<i data-lucide="save" class="w-4 h-4"></i> Update`;
            document.getElementById('btn-add-item').className = "flex-1 bg-green-600 hover:bg-green-700 text-white py-3.5 rounded-xl font-bold shadow-lg shadow-green-200 transition-all flex justify-center items-center gap-2";
            document.getElementById('edit-form-title').innerText = "Edit Item";
            document.getElementById('btn-cancel-edit').classList.remove('hidden');
        }

        function deleteItem(id) {
            if(confirm('Remove this item?')) {
                data.items = data.items.filter(i => i.id !== id);
                save();
                renderJourney();
            }
        }

        function calcDuration(d1,t1,d2,t2){
            if(!d1||!t1||!d2||!t2) return null;
            const s=new Date(`${d1}T${t1}`), e=new Date(`${d2}T${t2}`), diff=e-s;
            if(diff<=0) return null;
            const h=Math.floor(diff/36e5), m=Math.floor((diff%36e5)/6e4);
            return h>0 ? `${h}h ${m}m` : `${m}m`;
        }

        function renderJourney() {
            const container = document.getElementById('timeline-feed');
            container.innerHTML = '';
            
            if(data.items.length === 0){
                document.getElementById('journey-empty').classList.remove('hidden');
                return;
            }
            document.getElementById('journey-empty').classList.add('hidden');

            // Unique Dates Logic
            const dates = new Set();
            data.items.forEach(i => {
                dates.add(i.startDate);
                if(i.endDate && i.endDate > i.startDate){
                    let curr = new Date(i.startDate);
                    let end = new Date(i.endDate);
                    // Add intermediate dates if needed, mostly for stays
                    // Simplified: just add start/end for simplicity in view
                    dates.add(i.endDate);
                }
            });
            
            const sortedDates = Array.from(dates).sort();

            sortedDates.forEach(d => {
                // Filter items for this date
                let itemsForDate = data.items.filter(i => i.startDate === d || (i.type === 'stay' && i.startDate <= d && i.endDate >= d));
                
                // Apply Category Filter
                if(activeFilter !== 'all') {
                    itemsForDate = itemsForDate.filter(i => i.type === activeFilter);
                }

                if(itemsForDate.length === 0) return;

                // Sort by time
                itemsForDate.sort((a,b) => (a.startTime||'').localeCompare(b.startTime||''));

                // Render Date Header
                const dateObj = new Date(d);
                const dayStr = dateObj.toLocaleDateString('en-US', {weekday:'short', month:'short', day:'numeric'});
                
                const card = document.createElement('div');
                card.className = "relative pl-6 md:pl-8 border-l-2 border-gray-100 ml-2 md:ml-4";
                
                let html = `
                    <div class="absolute left-[-5px] top-0 w-3 h-3 bg-gray-300 rounded-full border-2 border-white"></div>
                    <h3 class="text-lg md:text-xl font-black text-gray-800 mb-4 pl-2">${dayStr}</h3>
                    <div class="space-y-4">
                `;

                itemsForDate.forEach(item => {
                    const isStay = item.type === 'stay';
                    const isTransit = item.type === 'flight' || item.type === 'transport';
                    
                    // Colors
                    let colorClass = "indigo";
                    if(item.type === 'flight') colorClass = "blue";
                    if(item.type === 'transport') colorClass = "emerald";
                    if(item.type === 'stay') colorClass = "orange";

                    const dur = calcDuration(item.startDate, item.startTime, item.endDate, item.endTime);
                    const badge = dur ? `<span class="ml-2 text-[10px] bg-gray-800 text-white px-1.5 py-0.5 rounded">${dur}</span>` : '';
                    
                    let title = isTransit ? `${item.from} ‚ûî ${item.to}` : item.name;
                    let timeStr = item.startTime || '';
                    if(item.endTime && item.endTime !== item.startTime) timeStr += ` - ${item.endTime}`;

                    html += `
                        <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100 hover:shadow-md transition-shadow relative group">
                            <div class="flex justify-between items-start">
                                <div class="flex-grow">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="text-[10px] font-bold uppercase text-${colorClass}-600 bg-${colorClass}-50 px-2 py-0.5 rounded">${item.type}</span>
                                        ${timeStr ? `<span class="font-mono text-xs text-gray-400 font-bold">${timeStr}</span>` : ''}
                                        ${badge}
                                    </div>
                                    <div class="font-bold text-gray-800 text-base md:text-lg flex items-center gap-2">
                                        <span class="text-xl">${item.icon}</span> ${title}
                                    </div>
                                    ${item.note ? `<div class="text-xs text-gray-500 mt-2 bg-gray-50 p-2 rounded">${item.note}</div>` : ''}
                                </div>
                                <div class="flex flex-col gap-2 pl-2">
                                    <button onclick="editItem(${item.id})" class="text-gray-300 hover:text-indigo-600"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                                    <button onclick="deleteItem(${item.id})" class="text-gray-300 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                    ${item.link ? `<a href="${item.link}" target="_blank" class="text-gray-300 hover:text-blue-500"><i data-lucide="map" class="w-4 h-4"></i></a>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += `</div>`;
                card.innerHTML = html;
                container.appendChild(card);
            });
            
            lucide.createIcons();
        }

        // --- BUDGET LOGIC ---
        function updateAllFromTotal() {
            data.totalBudget = parseInt(document.getElementById('smart-total').value) || 0;
            save();
            renderSmartBudget();
        }

        function updateLimitFromPercent(c, v) {
            if(data.totalBudget <= 0) return;
            data.limits[c] = Math.round(data.totalBudget * (parseFloat(v)||0) / 100);
            save(); renderSmartBudget();
        }

        function updatePercentFromLimit(c, v) {
            data.limits[c] = parseInt(v) || 0;
            save(); renderSmartBudget();
        }

        function addExpense(){
            const i = {
                id: Date.now(),
                cat: document.getElementById('exp-cat').value,
                name: document.getElementById('exp-item').value,
                date: document.getElementById('exp-date').value,
                cost: parseInt(document.getElementById('exp-cost').value),
                usd: parseFloat(document.getElementById('exp-usd').value),
                payer: document.getElementById('exp-payer').value,
                method: document.getElementById('exp-method').value,
                note: document.getElementById('exp-note').value
            };
            if(!i.name || isNaN(i.cost)) return alert("Item Name and KRW Cost are required");
            
            data.expenses.push(i);
            document.getElementById('exp-item').value = '';
            document.getElementById('exp-cost').value = '';
            document.getElementById('exp-usd').value = '';
            save();
            renderSmartBudget();
        }

        function deleteExpense(id) {
            if(confirm('Delete expense?')) {
                data.expenses = data.expenses.filter(e => e.id !== id);
                save();
                renderSmartBudget();
            }
        }

        function renderSmartBudget() {
            // Set Inputs
            document.getElementById('smart-total').value = data.totalBudget;

            // Calculate Sums
            let totalSpent = 0;
            const spentByCat = {};
            data.expenses.forEach(e => {
                spentByCat[e.cat] = (spentByCat[e.cat] || 0) + e.cost;
                totalSpent += e.cost;
            });
            document.getElementById('smart-spent').innerText = totalSpent.toLocaleString();

            // Render Limits Table
            const tbody = document.getElementById('smart-budget-rows');
            tbody.innerHTML = '';
            CATEGORIES.forEach(c => {
                const limit = data.limits[c] || 0;
                const percent = data.totalBudget > 0 ? ((limit / data.totalBudget) * 100).toFixed(1) : 0;
                const spent = spentByCat[c] || 0;
                const isOver = spent > limit && limit > 0;
                
                tbody.innerHTML += `
                    <tr class="border-b border-gray-50">
                        <td class="py-3 font-medium text-gray-700">${c}</td>
                        <td class="py-3">
                            <div class="flex gap-1 justify-end">
                                <input type="number" class="w-10 p-1 border rounded text-right text-xs bg-gray-50" value="${percent}" onchange="updateLimitFromPercent('${c}',this.value)">
                                <span class="text-xs text-gray-400 py-1">%</span>
                            </div>
                        </td>
                        <td class="py-3">
                            <input type="number" class="w-full p-1 border rounded text-right text-xs font-bold" value="${limit}" onchange="updatePercentFromLimit('${c}',this.value)">
                        </td>
                        <td class="py-3 text-right text-xs font-bold ${isOver ? 'text-rose-500' : 'text-gray-500'}">
                            ${spent.toLocaleString()}
                        </td>
                    </tr>
                `;
            });

            // Render Log List
            const listBody = document.getElementById('expense-list');
            listBody.innerHTML = data.expenses.sort((a,b) => b.id - a.id).map(e => `
                <tr class="hover:bg-gray-50 border-b border-gray-50 transition-colors">
                    <td class="py-3 px-4 text-gray-500 whitespace-nowrap">${e.date}</td>
                    <td class="py-3 px-4"><span class="px-2 py-1 bg-gray-100 rounded text-[10px] text-gray-600 font-bold uppercase">${e.cat}</span></td>
                    <td class="py-3 px-4 font-bold text-gray-800">${e.name}</td>
                    <td class="py-3 px-4 text-right font-mono text-gray-700">‚Ç©${e.cost.toLocaleString()}</td>
                    <td class="py-3 px-4 text-right font-mono text-gray-400">${e.usd ? '$'+e.usd : '-'}</td>
                    <td class="py-3 px-4 text-gray-500 text-xs">${e.payer||'-'}</td>
                    <td class="py-3 px-4 text-gray-500 text-xs">${e.method||'-'}</td>
                    <td class="py-3 px-4 text-gray-400 text-xs italic truncate max-w-[120px]">${e.note||''}</td>
                    <td class="py-3 px-2 text-center"><button onclick="deleteExpense(${e.id})" class="text-gray-300 hover:text-red-500 p-1"><i data-lucide="x" class="w-3 h-3"></i></button></td>
                </tr>
            `).join('');

            // Update Chart
            const remain = Math.max(0, data.totalBudget - totalSpent);
            const remainPct = data.totalBudget > 0 ? Math.round((remain / data.totalBudget)*100) : 0;
            document.getElementById('sum-remain-pct').innerText = remainPct + '%';
            document.getElementById('sum-spent-total').innerText = '‚Ç©' + totalSpent.toLocaleString();

            const ctx = document.getElementById('sumChartBudget').getContext('2d');
            if(chartBudget) chartBudget.destroy();
            chartBudget = new Chart(ctx, { 
                type: 'doughnut', 
                data: { 
                    labels: ['Spent', 'Remaining'], 
                    datasets: [{ 
                        data: [totalSpent, remain], 
                        backgroundColor: ['#e5e7eb', '#4f46e5'], 
                        borderWidth: 0 
                    }] 
                }, 
                options: { 
                    cutout: '75%', 
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: {display:false}, tooltip: {enabled:false} } 
                } 
            });
            lucide.createIcons();
        }

        // --- DASHBOARD LOGIC ---
        function renderSummary() {
            document.getElementById('sum-title').innerText = data.tripName;
            
            // Dates & D-Day
            const dates = data.items.map(i => i.startDate).sort();
            if(dates.length) {
                document.getElementById('sum-dates').innerText = `${dates[0]} ~ ${dates[dates.length-1]}`;
                const start = new Date(dates[0]);
                const today = new Date(); today.setHours(0,0,0,0);
                const diff = Math.ceil((start - today) / (1000*60*60*24));
                document.getElementById('sum-dday').innerText = diff > 0 ? `D-${diff}` : (diff===0 ? 'D-Day' : `Day ${Math.abs(diff)+1}`);
                document.getElementById('sum-dday').className = diff > 0 ? "text-xl md:text-3xl font-black text-indigo-600 bg-indigo-50 px-3 py-1 rounded-lg" : "text-xl md:text-3xl font-black text-white bg-rose-500 px-3 py-1 rounded-lg shadow-lg shadow-rose-200";
            } else {
                document.getElementById('sum-dates').innerText = "No schedule set";
                document.getElementById('sum-dday').innerText = "-";
            }

            // Counts
            const cnts = {activity:0, flight:0, stay:0};
            data.items.forEach(i=>{ if(cnts[i.type]!==undefined) cnts[i.type]++; });
            document.getElementById('cnt-flight').innerText = cnts.flight;
            document.getElementById('cnt-stay').innerText = cnts.stay;
            document.getElementById('cnt-activity').innerText = cnts.activity;

            // Route Map
            const routeBox = document.getElementById('sum-route-flow');
            routeBox.innerHTML = '';
            const routes = data.items.filter(i => (i.type==='flight'||i.type==='transport') && i.from && i.to).sort((a,b) => a.startDate.localeCompare(b.startDate));
            
            if(routes.length) {
                routes.forEach(r => {
                    routeBox.innerHTML += `
                        <div class="route-card flex-shrink-0 flex items-center gap-2 group">
                            <div class="flex flex-col items-center min-w-[70px]">
                                <span class="text-[10px] font-bold text-gray-400 mb-1">DEP</span>
                                <span class="font-bold text-gray-800 text-xs bg-gray-50 border border-gray-200 px-2 py-1 rounded-lg whitespace-nowrap">${r.from}</span>
                            </div>
                            <div class="route-connector flex flex-col items-center w-12">
                                <span class="text-xl mb-1 group-hover:scale-110 transition-transform">${r.icon}</span>
                                <div class="w-full h-0.5 bg-dashed bg-gray-300"></div>
                            </div>
                            <div class="flex flex-col items-center min-w-[70px]">
                                <span class="text-[10px] font-bold text-gray-400 mb-1">ARR</span>
                                <span class="font-bold text-gray-800 text-xs bg-gray-50 border border-gray-200 px-2 py-1 rounded-lg whitespace-nowrap">${r.to}</span>
                            </div>
                        </div>
                    `;
                });
            } else {
                routeBox.innerHTML = '<span class="text-xs text-gray-400 italic w-full text-center py-4">Add flights or transport to see route.</span>';
            }
        }
    </script>
</body>
</html>
